<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chicago</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="primary-color">
    <div id="app">
      <transition name="fade" mode="out-in">
        <section v-if="currentPhase===phases.START" key="start" class="phase">
          <h1>Chicago</h1>
          <add-players :players="players"></add-players>
          <player-list
            :players="players"
            :current-player="currentPlayer"
            @select-player="setCurrentPlayer"
          ></player-list>
          <start-button
            :players="players"
            :disabled="buttonsDisabled"
            :transitioning="transitioning"
            @start-game="started"
          ></start-button>
          <label class="checkbox-container">
            <input type="checkbox" v-model="callChicagoOnceToWin" />
            <span>
              {{ callChicagoOnceToWin ? `Call Chicago once to win` : `No Chicago
              needed to win` }}
            </span>
          </label>
        </section>
        <section
          v-if="currentPhase===phases.ROUND"
          class="phase"
          :key="`round-${currentRound}`"
        >
          <h1>{{phases.ROUND}} {{currentRound}}</h1>
          <h2 class="resetOutput">{{output}}</h2>
          <player-list
            :players="players"
            :current-player="currentPlayer"
            :change-score="changeScore"
            @select-player="setCurrentPlayer"
          ></player-list>
          <div class="grid-container">
            <button
              v-for="(value, index) in values.slice(0, -3)"
              :key="index"
              @click="addScore(index)"
              :disabled="buttonsDisabled || transitioning"
            >
              {{values[index].name}}
            </button>
          </div>
          <revert-score
            :current-phase="currentPhase"
            :phases="phases"
            :last-score="lastScore"
            @revert-last-score="revertLastScore"
          ></revert-score>
        </section>
        <section
          v-if="currentPhase===phases.CHICAGO"
          key="chicago"
          class="phase"
        >
          <h1>Chicago</h1>
          <player-list
            :players="players"
            :current-player="currentPlayer"
            :change-score="changeScore"
            @select-player="setCurrentPlayer"
          ></player-list>
          <div class="btnWrapper">
            <button
              @click="addScore(9)"
              :disabled="buttonsDisabled || transitioning"
              class="specialBtn"
            >
              {{values[9].name}}
            </button>
            <button
              @click="addScore(10)"
              :disabled="buttonsDisabled || transitioning"
              class="failureBtn"
            >
              {{values[10].name}}
            </button>
          </div>
          <revert-score
            :current-phase="currentPhase"
            :phases="phases"
            :last-score="lastScore"
            @revert-last-score="revertLastScore"
          ></revert-score>
        </section>
        <section v-if="currentPhase===phases.TRICK" key="trick" class="phase">
          <h1>{{phases.TRICK}}</h1>
          <player-list
            :players="players"
            :current-player="currentPlayer"
            :change-score="changeScore"
            @select-player="setCurrentPlayer"
          ></player-list>
          <div class="btnWrapper">
            <button
              @click="addScore(8)"
              :disabled="buttonsDisabled || transitioning"
              class="specialBtn"
            >
              {{values[8].name}}
            </button>
          </div>
          <revert-score
            :current-phase="currentPhase"
            :phases="phases"
            :last-score="lastScore"
            @revert-last-score="revertLastScore"
          ></revert-score>
        </section>
        <section
          v-if="currentPhase===phases.FINISHED"
          key="finished"
          class="phase"
        >
          <h1 class="gameOver">Game Over</h1>
          <p class="winningPhrase">
            The winner is
            <span class="currentPlayer" v-if="currentPlayer !== null"
              >{{winner?.name}}</span
            >
            with
            <span class="currentPlayer" v-if="currentPlayer !== null"
              >{{winner?.score}}</span
            >
            points!
          </p>
          <div class="btnWrapper">
            <button
              class="startBtn"
              @click="reset()"
              :disabled="buttonsDisabled"
            >
              Reset
            </button>
          </div>
          <result-list :players="players"></result-list>
        </section>
      </transition>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
      import { PlayerList } from "./components/PlayerList.js";
      import { StartButton } from "./components/StartButton.js";

      const { createApp } = Vue;
      createApp({
        data() {
          return {
            playerName: "",
            players: [],
            currentPlayer: null,
            phases: {
              START: "start",
              ROUND: "round",
              TRICK: "trick",
              CHICAGO: "chicago",
              FINISHED: "finished",
            },
            currentPhase: "start",
            currentRound: 1,
            values: [
              {
                name: "One pair (1)",
                points: 1,
              },
              {
                name: "Two pair (2)",
                points: 2,
              },
              {
                name: "Three of a kind (3)",
                points: 3,
              },
              {
                name: "Straight (4)",
                points: 4,
              },
              {
                name: "Flush (5)",
                points: 5,
              },
              {
                name: "Full House (6)",
                points: 6,
              },
              {
                name: "Four of a kind (8)",
                points: 8,
                reset: false,
              },
              {
                name: "Straight Flush (52)",
                points: 52,
              },
              {
                name: "Trick (5)",
                points: 5,
              },
              {
                name: "Success (15)",
                points: 15,
              },
              {
                name: "Failure (-15)",
                points: -15,
              },
            ],
            winner: null,
            output: "",
            currentDealer: null,
            changeScore: false,
            buttonsDisabled: false,
            transitioning: false,
            isChicago: false,
            callChicagoOnceToWin: false,
            lastScore: null,
          };
        },
        methods: {
          started() {
            if (this.buttonsDisabled) return;

            this.buttonsDisabled = true;

            this.nextPhase();
            setTimeout(() => {
              let randomNum = Math.floor(Math.random() * this.players.length);
              this.currentPlayer = randomNum;
              this.isDealer();

              this.buttonsDisabled = false;
            }, 1000);
          },

          addScore(valueIndex) {
            if (this.buttonsDisabled) return;

            this.buttonsDisabled = true;

            setTimeout(() => {
              let currentValue = this.values[valueIndex];
              let player = this.players[this.currentPlayer];

              player.score += currentValue.points;
              player.values.push(currentValue);

              this.lastScore = {
                player: player,
                value: currentValue,
              };

              let chicagoSuccess = 9;
              let chicagoFailure = 10;
              if (valueIndex === chicagoSuccess) {
                player.calledChicago.successes++;
              } else if (valueIndex === chicagoFailure) {
                player.calledChicago.failures++;
              }

              this.showScoring();
              this.nextPhase();

              this.buttonsDisabled = false;
            }, 1000);
            this.output = "";
          },
          setCurrentPlayer(index) {
            this.currentPlayer = index;
          },
          nextPhase() {
            this.transitioning = true;

            setTimeout(() => {
              if (this.currentPhase === this.phases.FINISHED) {
                this.currentPhase = this.phases.START;
              }
              if (this.currentPhase === this.phases.START) {
                this.currentPhase = this.phases.ROUND;
              } else if (this.currentPhase === this.phases.ROUND) {
                if (this.currentRound === 1) {
                  this.currentRound++;
                } else if (this.currentRound === 2) {
                  this.isChicago = confirm(
                    "Round 2 has ended. Does anyone wish to call Chicago?"
                  );
                  if (this.isChicago) {
                    this.currentPhase = this.phases.CHICAGO;
                  } else {
                    this.currentPhase = this.phases.TRICK;
                  }
                } else if (this.currentRound === 3) {
                  this.checkWinner();
                }
              } else if (this.currentPhase === this.phases.TRICK) {
                this.currentPhase = this.phases.ROUND;
                if (this.currentRound < 3) {
                  this.currentRound++;
                }
              } else if (this.currentPhase === this.phases.CHICAGO) {
                this.checkWinner();
              }

              this.transitioning = false;
            }, 1000);
          },
          checkWinner() {
            let winningThreshhold = 52;
            let highestPoint = 0;
            let winnerName = "";
            let playerIndex = "";
            this.players.forEach((player, index) => {
              if (player.score > highestPoint) {
                highestPoint = player.score;
                winnerName = player.name;
                playerIndex = index;
              }
            });
            if (
              highestPoint >= winningThreshhold &&
              (!this.callChicagoOnceToWin ||
                this.players[playerIndex].calledChicago.successes > 0 ||
                this.players[playerIndex].calledChicago.failures > 0)
            ) {
              this.currentPhase = this.phases.FINISHED;
              this.winner = {
                name: winnerName,
                score: highestPoint,
              };
            } else {
              this.currentPhase = this.phases.ROUND;
              this.currentRound = 1;
              this.output = "New round - first to reach 52 wins!";
              this.lastScore = null;
              this.players[this.currentDealer].dealer = false;
              this.isDealer();
            }
          },
          isDealer() {
            let playersLength = this.players.length;
            let randNum = Math.floor(Math.random() * playersLength);
            if (this.currentDealer === null) {
              this.currentDealer = randNum;
            } else if (this.currentDealer === playersLength - 1) {
              this.currentDealer = 0;
            } else {
              this.currentDealer++;
            }
            this.players[this.currentDealer].dealer = true;
          },
          showScoring() {
            this.changeScore = true;
            setTimeout(() => {
              this.changeScore = false;
            }, 1000);
          },
          reset() {
            if (this.buttonsDisabled) return;

            this.buttonsDisabled = true;

            setTimeout(() => {
              this.isDealer();
              this.currentPhase = this.phases.START;
              this.currentRound = 1;
              this.currentPlayer = null;
              this.winner = null;
              this.output = "";
              this.players = [];
              this.buttonsDisabled = false;
            }, 1000);
          },
          revertLastScore() {
            let lastValue = this.lastScore.value;
            this.lastScore.player.score -= lastValue.points;
            this.lastScore.player.values.pop();
            this.lastScore = null;

            if (this.currentPhase == this.phases.ROUND) {
              if (this.currentRound == 2) {
                this.currentRound = 1;
              } else if (this.currentRound == 3) {
                this.currentPhase = this.phases.TRICK;
              }
            } else if (this.currentPhase == this.phases.TRICK) {
              this.currentPhase = this.phases.ROUND;
              this.currentRound = 2;
            } else if (this.currentPhase == this.phases.CHICAGO) {
              this.currentPhase = this.phases.ROUND;
              this.currentRound = 2;
            }
          },
        },
      })
        .component("player-list", PlayerList)
        .component("add-players", {
          props: ["players"],
          inheritAttrs: true,
          template: `<div class="inputWrapper">
                  <input
                    v-model.trim="playerName"
                    placeholder="Add player"
                    @keyup.enter="addPlayer"
                    @input="playerName = $event.target.value"
                    maxlength="15"
                  />
                  <button v-if="playerName.length > 0" @click="addPlayer">Ok</button>
                  </div>
                  <div class="outputWrapper">
                  <p class="output">{{output}}</p>
                   </div>
                    `,
          data() {
            return {
              playerName: "",
              output: "",
            };
          },
          methods: {
            addPlayer() {
              let name = this.playerName.trim();
              if (name === "") {
                this.output = "Name must be at least one letter!";
              } else if (this.players.length > 3) {
                this.output = "Maximum number of players!";
              } else {
                this.output = "";
                this.players.push({
                  name: name,
                  values: [],
                  score: 0,
                  dealer: false,
                  calledChicago: {
                    successes: 0,
                    failures: 0,
                  },
                });
                this.playerName = "";
              }
            },
          },
        })
        .component("start-button", StartButton)
        .component("revert-score", {
          props: ["currentPhase", "phases", "lastScore"],
          inheritAttrs: true,
          template: `<div class="btnWrapper">
                      <button @click="$emit('revert-last-score')" :disabled="!lastScore" class="startBtn">
                        Revert
                      </button>
                     </div>`,
        })
        .component("result-list", {
          props: ["players"],
          inheritAttrs: true,
          template: `<div>
            <ul class="results-list">
              <li v-for="player in players" :key="player.name">
                <strong>{{ player.name }}</strong>
                <div>Score: <span>{{ player.score }}</span></div>
                <div>
                  Chicago → ✅ {{ player.calledChicago.successes }} | ❌ {{
                  player.calledChicago.failures }}
                </div>
                <br />
              </li>
            </ul>
          </div>`,
        })
        .mount("#app");
    </script>
  </body>
</html>
