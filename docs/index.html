<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chicago</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app" class="primary-color">
      <h1>Chicago</h1>
      <h2 class="resetOutput">{{output}}</h2>
      <section v-if="currentPhase===phases.START">
        <add-players
          :players="players"
          header="Add players"
          class="phaseStart"
        ></add-players>
        <player-list
          :players="players"
          :current-player="currentPlayer"
          @select-player="setCurrentPlayer"
          class="playerList"
        ></player-list>
        <start :players="players" @start-game="started"></start>
      </section>
      <section>
        <section v-if="currentPhase===phases.ROUND" class="phaseRounds">
          <h2>{{phases.ROUND}} {{currentRound}}</h2>
          <player-list
            :players="players"
            :current-player="currentPlayer"
            :change-score="changeScore"
            @select-player="setCurrentPlayer"
            class="playerList"
          ></player-list>
          <p>
            Add score to:
            <span class="currentPlayer" v-if="currentPlayer !== null"
              >{{players[currentPlayer].name}}</span
            >
          </p>
          <div class="grid-container">
            <button @click="addScore(0)">{{values[0].name}}</button>
            <button @click="addScore(1)">{{values[1].name}}</button>
            <button @click="addScore(2)">{{values[2].name}}</button>
            <button @click="addScore(3)">{{values[3].name}}</button>
            <button @click="addScore(4)">{{values[4].name}}</button>
            <button @click="addScore(5)">{{values[5].name}}</button>
            <button @click="addScore(6)">{{values[6].name}}</button>
            <button @click="addScore(7)">{{values[7].name}}</button>
          </div>
          <p>
            Dealer: <span class="dealer">{{players[currentDealer].name}}</span>
          </p>
        </section>
      </section>
      <section class="phaseTrick">
        <section v-if="currentPhase===phases.TRICK">
          <h2>{{phases.TRICK}}</h2>
          <player-list
            :players="players"
            :current-player="currentPlayer"
            :change-score="changeScore"
            @select-player="setCurrentPlayer"
            class="playerList"
          ></player-list>
          <p>
            Add score to:
            <span class="currentPlayer" v-if="currentPlayer !== null"
              >{{players[currentPlayer].name}}</span
            >
          </p>
          <div class="btnWrapper">
            <button @click="addScore(8)">{{values[8].name}}</button>
          </div>
          <p>
            Dealer: <span class="dealer">{{players[currentDealer].name}}</span>
          </p>
        </section>
      </section>
      <section v-if="currentPhase===phases.FINISHED">
        <h2 class="gameOver">Game Over</h2>
        <p class="winningPhrase">
          The winner is
          <span class="currentPlayer" v-if="currentPlayer !== null"
            >{{winner?.name}}</span
          >
          with
          <span class="currentPlayer" v-if="currentPlayer !== null"
            >{{winner?.score}}</span
          >
          points!
        </p>
        <div class="btnWrapper">
          <button class="startBtn" @click="reset()">Reset</button>
        </div>
        <ul>
          <li v-for="player in players">{{player.name}}: {{player.score}}</li>
        </ul>
      </section>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            playerName: "",
            players: [],
            currentPlayer: null,
            phases: {
              START: "start",
              ROUND: "round",
              TRICK: "trick",
              FINISHED: "finished",
            },
            currentPhase: "start",
            currentRound: 1,
            values: [
              {
                name: "One pair (1)",
                points: 1,
              },
              {
                name: "Two pair (2)",
                points: 2,
              },
              {
                name: "Three of a kind (3)",
                points: 3,
              },
              {
                name: "Straight (4)",
                points: 4,
              },
              {
                name: "Flush (5)",
                points: 5,
              },
              {
                name: "Full House (6)",
                points: 6,
              },
              {
                name: "Four of a kind (8)",
                points: 8,
                reset: false,
              },
              {
                name: "Straight Flush (52)",
                points: 52,
              },
              {
                name: "Trick (5)",
                points: 5,
              },
            ],
            winner: null,
            output: "",
            currentDealer: null,
            changeScore: false,
          };
        },
        methods: {
          started() {
            this.nextPhase();

            let randomNum = Math.floor(Math.random() * this.players.length);
            this.currentPlayer = randomNum;
            this.isDealer();
          },

          addScore(valueIndex) {
            setTimeout(() => {
              this.players[this.currentPlayer].score +=
                this.values[valueIndex].points;
              this.showScoring();
              this.nextPhase();
            }, 300);
            this.output = "";
          },
          setCurrentPlayer(index) {
            this.currentPlayer = index;
          },
          nextPhase() {
            setTimeout(() => {
              if (this.currentPhase === this.phases.FINISHED) {
                this.currentPhase = this.phases.START;
              }
              if (this.currentPhase === this.phases.START) {
                this.currentPhase = this.phases.ROUND;
              } else if (this.currentPhase === this.phases.ROUND) {
                if (this.currentRound === 1) {
                  this.currentRound++;
                } else if (this.currentRound === 2) {
                  this.currentPhase = this.phases.TRICK;
                  this.currentRound++;
                } else if (this.currentRound === 3) {
                  this.checkWinner();
                }
              } else if (this.currentPhase === this.phases.TRICK) {
                this.currentPhase = this.phases.ROUND;
                this.currentRound = 3;
              }
            }, 1500);
          },
          checkWinner() {
            let winningThreshhold = 52;
            let highestPoint = 0;
            let winnerName = "";
            this.players.forEach((player) => {
              if (player.score > highestPoint) {
                highestPoint = player.score;
                winnerName = player.name;
              }
            });
            if (highestPoint >= winningThreshhold) {
              this.currentPhase = this.phases.FINISHED;
              this.winner = {
                name: winnerName,
                score: highestPoint,
              };
            } else {
              this.currentPhase = this.phases.ROUND;
              this.currentRound = 1;
              this.output = "New round - first to reach 52 wins!";
              this.isDealer();
            }
          },
          isDealer() {
            let playersLength = this.players.length;
            let randNum = Math.floor(Math.random() * playersLength);
            if (this.currentDealer === null) {
              this.currentDealer = randNum;
              console.log(this.currentDealer + "if");
            } else if (this.currentDealer === playersLength - 1) {
              this.currentDealer = 0;
            } else {
              this.currentDealer++;
            }
          },
          showScoring() {
            this.changeScore = true;
            setTimeout(() => {
              this.changeScore = false;
            }, 1000);
          },
          reset() {
            setTimeout(() => {
              this.isDealer();
              this.currentPhase = this.phases.START;
              this.currentRound = 1;
              this.currentPlayer = null;
              this.winner = null;
              this.output = "";
              this.players = [];
            }, 1500);
          },
        },
      })
        .component("player-list", {
          props: ["players", "currentPlayer", "changeScore"],
          inheritAttrs: true,
          template: `<div>
    <p v-for="(player, index) in players" :key="index" :class="{current: true}"
       @click="$emit('select-player', index)">{{player.name}}:
       <span class="score" :class="{highlightScore: changeScore && index === currentPlayer}">{{player.score}}</span>
    </p>
  </div>`,
        })
        .component("add-players", {
          props: ["players", "header"],
          inheritAttrs: true,
          template: `<div class="inputWrapper">
                <h2>{{header}}</h2>
              <input
                v-model.trim="playerName"
                placeholder="Name"
                @keyup.enter="addPlayer"
                @input="playerName = $event.target.value"
              />
              <button v-if="playerName.length > 0" @click="addPlayer">Ok</button>
              <p class="output">{{output}}</p>
              </div>
                `,
          data() {
            return {
              playerName: "",
              output: "",
            };
          },
          methods: {
            addPlayer() {
              let name = this.playerName.trim();
              if (name === "") {
                this.output = "Name must be at least one letter!";
              } else {
                this.output = "";
                this.players.push({
                  name: name,
                  score: 0,
                  dealer: false,
                });
                this.playerName = "";
              }
            },
          },
        })
        .component("start", {
          props: ["players"],
          inheritAttrs: true,
          template: `<div class="btnWrapper">
                <button v-if="players.length > 1"  @click="$emit('start-game')" class="startBtn">
                  Start
                </button>
              </div>`,
        })
        .mount("#app");
    </script>
  </body>
</html>
